image: $DOCKER_REGISTRE_URL/$DOCKER_REGISTRE_NAMESPACE_INT/node:18-build

include:
  - project: 'build/gitlab/gitlab-ci'
    file: '/templates/base.yml'

stages:
  - test
  - sonar
  - release

default:
  interruptible: true # allows to cancel the job automatically

.dependencies:
  before_script:
    - corepack enable
    - pnpm i
    - pnpm build

lint:
  stage: test
  extends:
    - .dependencies
  script:
    - pnpm lint

test:unit:
  stage: test
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  extends:
    - .dependencies
  script:
    - pnpm coverage
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - coverage
    reports:
      junit:
        - coverage/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

test:e2e:
  stage: test
  extends:
    - .dependencies
  script:
    - pnpm test:e2e
  retry: 2

sonar:
  stage: sonar
  variables:
    GIT_DEPTH: 0
  extends:
    - .dependencies
  rules:
    - if: $CI_COMMIT_TAG == null
  script:
    - gitlabci-quality-gate A+++
    - sonar-scanner -D sonar.login=$SONAR_KEY
    - gitlabci-sonar-compare report
  needs:
    - test:unit

release:
  stage: release
  extends:
    - .dependencies
  rules:
    # only tags and master branch
    - if: $CI_COMMIT_TAG && '$CI_COMMIT_REF_NAME == "master"'
  script:
    - pnpm publish -r --no-git-checks
