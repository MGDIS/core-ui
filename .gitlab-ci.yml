image: $DOCKER_REGISTRE_URL/$DOCKER_REGISTRE_NAMESPACE_INT/node:18-build

include:
  - project: 'build/gitlab/gitlab-ci'
    file: '/templates/base.yml' # https://gitlab.mgdis.fr/build/gitlab/gitlab-ci/-/blob/master/templates/base.yml

stages:
  - test
  - sonar
  - artifact
  - review
  - release

default:
  interruptible: true # allows to cancel the job automatically

.dependencies:
  before_script:
    - corepack enable
    - pnpm i

# stage: test

lint:
  stage: test
  extends:
    - .dependencies
  script:
    - pnpm lint

test:unit:
  stage: test
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  extends:
    - .dependencies
  script:
    - pnpm coverage
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - coverage
    reports:
      junit:
        - coverage/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml

# TODO: uncomment this block (taking too long and break)
# test:e2e:
#   stage: test
#   extends:
#     - .dependencies
#   script:
#     - pnpm test:e2e
#   retry: 2

# stage: sonar

sonar:
  stage: sonar
  variables:
    GIT_DEPTH: 0
  extends:
    - .dependencies
  rules:
    - if: $CI_COMMIT_TAG == null # except tags
  script:
    - gitlabci-quality-gate A+++
    - sonar-scanner -D sonar.login=$SONAR_KEY
    - gitlabci-sonar-compare report
  needs:
    - test:unit

# stage: artifact

artifact:mg-components:
  stage: artifact
  rules:
    - if: $CI_COMMIT_TAG == null # except tags
  extends:
    - .dependencies
  script:
    - cd packages/mg-components
    - version=`cat package.json | jq -r '.version'`-$CI_COMMIT_REF_SLUG-$CI_PIPELINE_ID
    - pnpm version --no-git-tag-version $version
    - pnpm publish --no-git-checks

# stage: review

review:mg-components:
  stage: review
  rules:
    # only MRs
    - if: $CI_MERGE_REQUEST_ID
  extends:
    - .dependencies
  script:
    - cd packages/mg-components
    - pnpm build
    - pnpm storybook:build
    - mv storybook-static ../../public
  artifacts:
    paths:
      - public
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: 'http://core.pages.mgdis.fr/-/core-ui/$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/artifacts/public/index.html'
    on_stop: review:mg-components:stop
    auto_stop_in: 1 week

review:mg-components:stop:
  stage: review
  rules:
    # only MRs
    - if: $CI_MERGE_REQUEST_ID
      when: manual
  script:
    - echo "ðŸ‘‹"
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
# stage: release

# chromatic-publish:
#   stage: release
#   rules:
#     - if: $CI_COMMIT_TAG # only tags
#   extends:
#     - .dependencies
#   script:
#     - npx chromatic --project-token=$CHROMATIC_PROJECT_TOKEN --auto-accept-changes --branch-name master --build-script-name storybook:build

# bot-publish:
#   stage: bot-publish
#   rules:
#     - if: $CI_COMMIT_TAG # only tags
#   script:
#     - cd tools/release-bot
#     - npm ci
#     - ./bin/release.js

# pages:
#   stage: deploy
#   rules:
#     - if: $CI_COMMIT_TAG # only tags
#   extends:
#     - .dependencies
#   script:
#     - cd packages/mg-components
#     - pnpm storybook:build
#     - mv storybook-static public
#   needs:
#     - dist
#   artifacts:
#     paths:
#       - public

# release:
#   stage: release
#   extends:
#     - .dependencies
#   rules:
#     - if: $CI_COMMIT_TAG && '$CI_COMMIT_REF_NAME == "master"' # only tags and master branch
#   script:
#     - pnpm publish -r --no-git-checks
